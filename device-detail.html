<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Device detail - AssetFlow IT</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/shared.css">
  <link rel="stylesheet" href="css/device-detail.css">
  <script src="js/qrcode.min.js"></script>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <button class="sidebar-toggle" title="Toggle Sidebar">‚ò∞</button>
        <a href="index.html" class="logo">
          <div class="logo-icon">üíª</div>
          <span>AssetFlow IT</span>
        </a>
      </div>
      <div class="header-right">
        <button class="mobile-menu-toggle">‚ò∞</button>
      </div>
    </div>
  </header>

  <div class="sidebar">
    <div class="sidebar-content">
      <div class="sidebar-section">
        <a href="index.html" class="sidebar-item active" data-title="Device list">
          <i class="fas fa-box sidebar-item-icon"></i>
          <span>Device List</span>
        </a>
        <a href="user-list.html" class="sidebar-item" data-title="User list">
          <i class="fas fa-users sidebar-item-icon"></i>
          <span>User List</span>
        </a>
        <a href="qr-scan.html" class="sidebar-item" data-title="QR scan">
          <i class="fas fa-qrcode sidebar-item-icon"></i>
          <span>QR scan</span>
        </a>
      </div>
    </div>
    
    <div class="sidebar-user-profile">
      <div class="user-profile">
        <div class="user-avatar">JD</div>
        <div class="user-info">
          <span class="user-name">John Doe</span>
          <span class="user-email">johndoe@company.com</span>
        </div>
      </div>
    </div>
  </div>

  <main class="main-content">
    <h1 class="page-title">Device detail</h1>
    <div class="detail-container">
      <div class="detail-main">
        <div class="detail-header">
          <div class="detail-header-top">
            <button class="back-btn" onclick="window.history.back()">‚Üê</button>
            <h1 class="detail-title" id="detailTitle">Device</h1>
            <div class="status-badge" id="headerStatusBadge" style="font-size: 0.875rem;"></div>
          </div>
          
          <div class="device-name-large" id="deviceNameLarge">Loading...</div>
          
          <div class="device-image-container">
            <div class="device-image-large" id="deviceImageLarge">üì¶</div>
          </div>
          
          <div class="location-tag" id="locationTag">
            <span id="locationText">Location</span>
          </div>
          
          <div class="device-metrics" id="deviceMetrics"></div>
          
          <div class="control-modes" id="controlModes"></div>
          
          <div class="detail-note-section" id="detailNoteSection" style="display: none;"></div>
        </div>
      </div>
      
      <div class="detail-content">
        <div class="tabs" id="detailTabs">
          <button class="tab active" data-tab="overview">Overview</button>
          <button class="tab" data-tab="hierarchy" id="hierarchyTabBtn">Hierarchy</button>
          <button class="tab" data-tab="history">History</button>
          <button class="tab" data-tab="specs" id="specsTabBtn">Specifications</button>
        </div>
        
        <div class="tab-content active" id="overviewTab">
          <div class="content-card" id="overviewContentCard" style="display: flex; gap: 2rem; align-items: flex-start;">
            <div style="flex: 1;">
              <h3 style="margin-bottom: 1rem;">Device Information</h3>
              <div id="overviewContent"></div>
            </div>
            <div id="qrCodeSidebar" style="min-width: 250px; display: none;"></div>
          </div>
        </div>
        
        <div class="tab-content" id="hierarchyTab">
          <div class="content-card">
            <div class="hierarchy-header">
              <h3 style="margin-bottom: 1rem;">Device Hierarchy</h3>
              <button class="btn btn-secondary add-component-btn" id="addComponentBtn" type="button">
                <span class="add-icon">+</span>
                <span>Add Component</span>
              </button>
            </div>
            <div class="hierarchy-tree" id="hierarchyTree"></div>
          </div>
        </div>
        
        <div class="tab-content" id="historyTab">
          <div class="content-card">
            <h3 style="margin-bottom: 1rem;">Lifecycle History</h3>
            <div class="lifecycle-timeline" id="historyContent"></div>
          </div>
        </div>
        
        <div class="tab-content" id="specsTab">
          <div class="content-card">
            <h3 style="margin-bottom: 1rem;" id="specsTabTitle">Technical Specifications</h3>
            <div class="specs-grid" id="specsGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- QR Code Modal -->
  <div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
      <div class="qr-modal-header">
        <div>
          <h2 id="qrModalTitle">QR code</h2>
          <p id="qrModalSubtitle"></p>
        </div>
        <button class="qr-modal-close" onclick="closeQRModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="qr-code-container" id="qrCodeContainer">
        <canvas id="qr-canvas"></canvas>
      </div>
      <p class="qr-modal-hint">Qu√©t QR code ƒë·ªÉ xem th√¥ng tin t√†i s·∫£n</p>
      <div class="qr-modal-actions">
        <button class="qr-action-btn" onclick="downloadQRCodeModal()">
          <i class="fas fa-download"></i>
          <span>T·∫£i xu·ªëng</span>
        </button>
        <button class="qr-action-btn" onclick="shareQRCodeModal()">
          <i class="fas fa-share-alt"></i>
          <span>Chia s·∫ª</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Add Component Modal -->
  <div class="component-modal-overlay" id="addComponentModal">
    <div class="component-modal-content">
      <div class="component-modal-header">
        <h2>Add component</h2>
        <button class="component-modal-close" type="button" onclick="closeAddComponentModal()">√ó</button>
      </div>
      <div class="component-modal-body">
        <p class="component-modal-description">
          Select an existing component to attach to this device hierarchy. This action is mock-only and will not be saved to the backend.
        </p>
        <div class="component-select-wrapper" id="componentSelectWrapper">
          <div class="component-select-display" id="componentSelectDisplay">
            Select a component...
          </div>
          <div class="component-options" id="componentOptions"></div>
          <!-- Hidden native select for accessibility / fallback -->
          <select id="componentSelect" class="component-select-hidden"></select>
        </div>
        <div id="componentEmptyState" class="component-empty-state" style="display: none;">
          No available components to add.
        </div>
      </div>
      <div class="component-modal-actions">
        <button class="btn btn-secondary" type="button" id="cancelAddComponentBtn">Cancel</button>
        <button class="btn btn-primary" type="button" id="confirmAddComponentBtn">Add</button>
      </div>
    </div>
  </div>

  <script src="js/shared.js"></script>
  <script>
    let currentDevice = null;
    let allEmployees = [];
    let allDevices = [];
    
    async function loadDevice() {
      const urlParams = new URLSearchParams(window.location.search);
      const deviceId = urlParams.get('id') || 'DEV001';
      
      // Load devices, software accounts v√† users song song
      const [devices, softwareAccounts, users] = await Promise.all([
        AssetFlowUtils.loadJSON('data/devices.json'),
        AssetFlowUtils.loadJSON('data/software-accounts.json'),
        AssetFlowUtils.loadJSON('data/users.json')
      ]);
      
      allDevices = Array.isArray(devices) ? devices : [];
      
      allEmployees = Array.isArray(users) 
        ? users.filter(u => u.role === 'Employee')
        : [];
      
      // T√¨m device trong danh s√°ch parent
      currentDevice = devices.find(d => d.id === deviceId);
      
      // N·∫øu kh√¥ng t√¨m th·∫•y, t√¨m trong children c·ªßa c√°c devices
      if (!currentDevice) {
        for (let device of devices) {
          if (device.children && device.children.length > 0) {
            const child = device.children.find(c => c.id === deviceId);
            if (child) {
              currentDevice = {
                ...child,
                parentDevice: {
                  id: device.id,
                  name: device.name,
                  serialNumber: device.serialNumber,
                  location: device.location,
                  holder: device.holder,
                  purchaseDate: device.purchaseDate,
                  warrantyExpiry: device.warrantyExpiry,
                  price: device.price
                },
                // Inherit location & holder t·ª´ cha ƒë·ªÉ hi·ªÉn th·ªã th·ªëng nh·∫•t
                location: device.location,
                holder: device.holder
              };
              break;
            }
          }
        }
      }
      
      // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, t√¨m trong software accounts
      if (!currentDevice) {
        const account = softwareAccounts.find(a => a.id === deviceId);
        if (account) {
          currentDevice = {
            ...account,
            category: 'Software Account',
            isSoftwareAccount: true
          };
          
          // Migrate assignedUsers to assignedDevices for Software accounts
          if (currentDevice.isSoftwareAccount && currentDevice.assignedUsers && currentDevice.assignedUsers.length > 0) {
            if (!currentDevice.assignedDevices) {
              // T√¨m PC/Laptop c·ªßa t·ª´ng user v√† convert sang device
              currentDevice.assignedDevices = currentDevice.assignedUsers.map(user => {
                // T√¨m PC/Laptop m√† user n√†y ƒëang s·ªü h·ªØu
                const userPC = allDevices.find(d => {
                  const isPCorLaptop = d.type === 'Laptop' || d.type === 'PC Case' || d.type === 'Desktop';
                  return isPCorLaptop && d.holder && d.holder.id === user.id;
                });
                
                if (userPC) {
                  // N·∫øu t√¨m th·∫•y PC/Laptop, s·ª≠ d·ª•ng device ƒë√≥
                  return {
                    type: 'device',
                    device: {
                      ...userPC,
                      name: userPC.name || userPC.id,
                      location: userPC.location,
                      holder: userPC.holder
                    },
                    assignedDate: user.assignedDate || new Date().toISOString().split('T')[0]
                  };
                } else {
                  // N·∫øu kh√¥ng t√¨m th·∫•y PC/Laptop, gi·ªØ nguy√™n user (fallback)
                  const fullUser = allEmployees.find(u => u.id === user.id) || user;
                  return {
                    type: 'user',
                    user: {
                      ...user,
                      ...fullUser,
                      team: fullUser.team || fullUser.department || user.team,
                      department: fullUser.department || fullUser.team || user.team
                    },
                    assignedDate: user.assignedDate || new Date().toISOString().split('T')[0]
                  };
                }
              });
            }
          }
        }
      }
      
      if (!currentDevice) {
        document.getElementById('detailTitle').textContent = 'Device not found';
        return;
      }
      
      renderDevice();
      
      // Generate QR code if available
      if (currentDevice && currentDevice.qrCode) {
        generateQRCode();
      }
    }
    
    function generateQRCode() {
      const canvas = document.getElementById('qr-canvas-detail');
      if (!canvas || !currentDevice || !currentDevice.qrCode) return;
      
      QRCode.toCanvas(canvas, currentDevice.qrCode, {
        width: 250,
        color: {
          dark: "#000000",
          light: "#ffffff"
        }
      }, function (error) {
        if (error) {
          console.error('QR Code generation error:', error);
        } else {
          console.log('QR Code generated successfully!');
        }
      });
    }
    
    function downloadQRCodeDetail() {
      if (!currentDevice || !currentDevice.qrCode) {
        AssetFlowUtils.showToast('QR code not available', 'error');
        return;
      }
      
      const canvas = document.getElementById('qr-canvas-detail');
      if (!canvas) {
        AssetFlowUtils.showToast('QR code not ready', 'error');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `QR-${currentDevice.id}-${currentDevice.qrCode}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      AssetFlowUtils.showToast('QR code downloaded', 'success');
    }
    
    // QR Code Modal functions (for metrics icon)
    let currentQRModalData = null;
    
    function showQRCodeModal(qrCode, deviceName, deviceId) {
      currentQRModalData = { qrCode, deviceName, deviceId };
      
      // Update modal content
      document.getElementById('qrModalTitle').textContent = `QR Code - ${deviceId}`;
      document.getElementById('qrModalSubtitle').textContent = deviceName;
      
      // Clear previous QR code
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = '<canvas id="qr-canvas"></canvas>';
      
      // Generate QR code
      const canvas = document.getElementById('qr-canvas');
      const text = qrCode;
      
      QRCode.toCanvas(canvas, text, {
        width: 200,
        color: {
          dark: "#000000",
          light: "#ffffff"
        }
      }, function (error) {
        if (error) {
          console.error('QR Code generation error:', error);
          container.innerHTML = `<div style="padding: 2rem; color: var(--text-secondary);">QR Code: ${qrCode}</div>`;
        } else {
          console.log('QR Code generated successfully!');
        }
      });
      
      // Show modal
      document.getElementById('qrModal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeQRModal() {
      document.getElementById('qrModal').classList.remove('active');
      document.body.style.overflow = '';
      currentQRModalData = null;
    }
    
    function downloadQRCodeModal() {
      if (!currentQRModalData) return;
      
      const canvas = document.getElementById('qr-canvas');
      if (!canvas) {
        AssetFlowUtils.showToast('QR code not ready', 'error');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `QR-${currentQRModalData.deviceId}-${currentQRModalData.qrCode}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
      
      AssetFlowUtils.showToast('QR code downloaded', 'success');
    }
    
    function shareQRCodeModal() {
      if (!currentQRModalData) return;
      
      const canvas = document.getElementById('qr-canvas');
      if (!canvas) {
        AssetFlowUtils.showToast('QR code not ready', 'error');
        return;
      }
      
      canvas.toBlob((blob) => {
        if (navigator.share && navigator.canShare) {
          const file = new File([blob], `QR-${currentQRModalData.deviceId}.png`, { type: 'image/png' });
          if (navigator.canShare({ files: [file] })) {
            navigator.share({
              title: `QR Code - ${currentQRModalData.deviceId}`,
              text: `${currentQRModalData.deviceName}`,
              files: [file]
            }).catch(err => {
              if (err.name !== 'AbortError') {
                AssetFlowUtils.showToast('Share failed', 'error');
              }
            });
          } else {
            copyQRToClipboardModal(canvas);
          }
        } else {
          copyQRToClipboardModal(canvas);
        }
      }, 'image/png');
    }
    
    function copyQRToClipboardModal(canvas) {
      canvas.toBlob((blob) => {
        navigator.clipboard.write([
          new ClipboardItem({ 'image/png': blob })
        ]).then(() => {
          AssetFlowUtils.showToast('QR code copied to clipboard', 'success');
        }).catch(() => {
          AssetFlowUtils.showToast('Copy failed', 'error');
        });
      });
    }
    
    // Close modal when clicking outside
    document.getElementById('qrModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'qrModal') {
        closeQRModal();
      }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const modal = document.getElementById('qrModal');
        if (modal && modal.classList.contains('active')) {
          closeQRModal();
        }
      }
    });
    
    // Initialize custom dropdowns for detail page
    function initializeDetailDropdowns() {
      // Status Dropdown
      const statusDropdown = document.getElementById('detailStatusDropdown');
      if (statusDropdown) {
        const button = statusDropdown.querySelector('.custom-dropdown-button');
        const menu = statusDropdown.querySelector('.custom-dropdown-menu');
        const hiddenSelect = statusDropdown.querySelector('select');
        const options = menu.querySelectorAll('.custom-dropdown-option');
        
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('show');
          closeAllDetailDropdowns();
          if (!isOpen) {
            menu.classList.add('show');
            button.classList.add('active');
          }
        });
        
        options.forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const value = option.dataset.value || '';
            
            // Update button text
            button.querySelector('.custom-dropdown-text').textContent = option.textContent.trim();
            
            // Update selected state
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // Update hidden select
            if (hiddenSelect) {
              hiddenSelect.value = value;
              hiddenSelect.dispatchEvent(new Event('change'));
            }
            
            // Close menu
            menu.classList.remove('show');
            button.classList.remove('active');
          });
        });
      }
      
      // Holder Dropdown
      const holderDropdown = document.getElementById('detailHolderDropdown');
      if (holderDropdown) {
        const button = holderDropdown.querySelector('.custom-dropdown-button');
        const menu = holderDropdown.querySelector('.custom-dropdown-menu');
        const hiddenSelect = holderDropdown.querySelector('select');
        const optionsContainer = holderDropdown.querySelector('#holderOptionsContainer');
        const searchInput = holderDropdown.querySelector('#holderSearchInput');
        
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('show');
          closeAllDetailDropdowns();
          if (!isOpen) {
            menu.classList.add('show');
            button.classList.add('active');
            // Clear search and show all options when opening
            if (searchInput) {
              searchInput.value = '';
              filterHolderOptions('', optionsContainer);
            }
            // Focus search input when opening
            setTimeout(() => {
              if (searchInput) searchInput.focus();
            }, 100);
          }
        });
        
        // Search functionality
        if (searchInput && optionsContainer) {
          let searchTimeout = null;
          
          searchInput.addEventListener('input', (e) => {
            e.stopPropagation();
            const query = e.target.value.trim().toLowerCase();
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
              filterHolderOptions(query, optionsContainer);
            }, 200);
          });
          
          searchInput.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
        
        // Handle option clicks (using event delegation for filtered options)
        if (optionsContainer) {
          optionsContainer.addEventListener('click', (e) => {
            const option = e.target.closest('.custom-dropdown-option');
            if (!option) return;
            
            e.stopPropagation();
            const value = option.dataset.value || '';
            
            // Update button text
            button.querySelector('.custom-dropdown-text').textContent = option.textContent.trim();
            
            // Update selected state
            const allOptions = optionsContainer.querySelectorAll('.custom-dropdown-option');
            allOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // Update hidden select
            if (hiddenSelect) {
              hiddenSelect.value = value;
              hiddenSelect.dispatchEvent(new Event('change'));
            }
            
            // Clear search and close menu
            if (searchInput) searchInput.value = '';
            filterHolderOptions('', optionsContainer);
            menu.classList.remove('show');
            button.classList.remove('active');
          });
        }
      }
      
      // Parent Device Dropdown
      const parentDropdown = document.getElementById('detailParentDeviceDropdown');
      if (parentDropdown) {
        const button = parentDropdown.querySelector('.custom-dropdown-button');
        const menu = parentDropdown.querySelector('.custom-dropdown-menu');
        const hiddenSelect = parentDropdown.querySelector('select');
        const options = menu.querySelectorAll('.custom-dropdown-option');
        
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const isOpen = menu.classList.contains('show');
          closeAllDetailDropdowns();
          if (!isOpen) {
            menu.classList.add('show');
            button.classList.add('active');
          }
        });
        
        options.forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const value = option.dataset.value || '';
            
            // Update button text
            button.querySelector('.custom-dropdown-text').textContent = option.textContent.trim();
            
            // Update selected state
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            
            // Update hidden select
            if (hiddenSelect) {
              hiddenSelect.value = value;
              hiddenSelect.dispatchEvent(new Event('change'));
            }
            
            // Close menu
            menu.classList.remove('show');
            button.classList.remove('active');
          });
        });
      }
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', (e) => {
        // Don't close if clicking inside dropdown menu (including search input)
        if (e.target.closest('.custom-dropdown-menu')) {
          return;
        }
        // Don't close if clicking on dropdown button (handled separately)
        if (e.target.closest('.custom-dropdown-button')) {
          return;
        }
        closeAllDetailDropdowns();
      });
    }
    
    function closeAllDetailDropdowns() {
      document.querySelectorAll('#detailStatusDropdown .custom-dropdown-menu, #detailHolderDropdown .custom-dropdown-menu, #detailParentDeviceDropdown .custom-dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
      });
      document.querySelectorAll('#detailStatusDropdown .custom-dropdown-button, #detailHolderDropdown .custom-dropdown-button, #detailParentDeviceDropdown .custom-dropdown-button').forEach(button => {
        button.classList.remove('active');
      });
    }
    
    function filterHolderOptions(query, container) {
      const options = container.querySelectorAll('.custom-dropdown-option');
      let hasVisible = false;
      
      options.forEach(option => {
        const searchText = option.dataset.searchText || '';
        const matches = !query || searchText.includes(query);
        
        if (matches) {
          option.style.display = '';
          hasVisible = true;
        } else {
          option.style.display = 'none';
        }
      });
      
      // Show "No results" message if no options match
      let noResultsMsg = container.querySelector('.holder-no-results');
      if (!hasVisible && query) {
        if (!noResultsMsg) {
          noResultsMsg = document.createElement('div');
          noResultsMsg.className = 'holder-no-results';
          noResultsMsg.style.cssText = 'padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.875rem;';
          noResultsMsg.textContent = 'No users found';
          container.appendChild(noResultsMsg);
        }
        noResultsMsg.style.display = 'block';
      } else if (noResultsMsg) {
        noResultsMsg.style.display = 'none';
      }
    }
    
    function renderDevice() {
      const isSoftwareAccount = currentDevice.isSoftwareAccount || currentDevice.category === 'Software Account';
      
      // Header
      document.getElementById('detailTitle').textContent = isSoftwareAccount ? 'Software Account' : currentDevice.type;
      document.getElementById('deviceNameLarge').textContent = currentDevice.name;
      
      // Icon - only show key icon for software accounts
      if (isSoftwareAccount) {
        document.getElementById('deviceImageLarge').innerHTML = '<i class="fas fa-key" style="font-size: 4rem; color: var(--primary-color);"></i>';
      } else {
        document.getElementById('deviceImageLarge').textContent = AssetFlowUtils.getDeviceIcon(currentDevice.type);
      }
      
      // Status badge in header
      const headerStatusBadge = document.getElementById('headerStatusBadge');
      headerStatusBadge.className = `status-badge status-${currentDevice.status}`;
      headerStatusBadge.textContent = AssetFlowUtils.getStatusDisplayName(currentDevice.status);
      
      // Location tag - show appropriate text
      if (isSoftwareAccount) {
        document.getElementById('locationText').textContent = 'Subscription Details';
      } else {
        document.getElementById('locationText').textContent = 'QR Code';
      }
      
      // Device metrics - only for software accounts
      const metricsContainer = document.getElementById('deviceMetrics');
      if (isSoftwareAccount) {
        const used = currentDevice.usedLicenses || 0;
        const total = currentDevice.totalLicenses || 0;
        const expiryDate = currentDevice.expiryDate ? AssetFlowUtils.formatDate(currentDevice.expiryDate) : 'N/A';
        const expiryDateObj = currentDevice.expiryDate ? new Date(currentDevice.expiryDate) : null;
        const today = new Date();
        const daysLeft = expiryDateObj ? Math.floor((expiryDateObj - today) / (1000 * 60 * 60 * 24)) : null;
        const isExpired = daysLeft !== null && daysLeft < 0;
        const expiryColor = isExpired ? '#ef4444' : (daysLeft !== null && daysLeft < 30 ? '#f59e0b' : '#10b981');
        
        metricsContainer.innerHTML = `
          <div class="software-stat-item">
            <i class="fas fa-calendar-times" style="font-size: 1.5rem; color: ${expiryColor}; margin-bottom: 0.5rem;"></i>
            <div class="software-stat-label">Expiry Date</div>
            <div class="software-stat-value" style="color: ${expiryColor};">${expiryDate}</div>
            ${daysLeft !== null ? `<div class="software-stat-subtext" style="color: ${expiryColor};">${isExpired ? 'Expired' : `${daysLeft} days left`}</div>` : ''}
          </div>
          <div class="software-stat-item">
            <i class="fas fa-users" style="font-size: 1.5rem; color: var(--primary-color); margin-bottom: 0.5rem;"></i>
            <div class="software-stat-label">In Use</div>
            <div class="software-stat-value">${used}</div>
            <div class="software-stat-subtext">users</div>
          </div>
          <div class="software-stat-item">
            <i class="fas fa-user-check" style="font-size: 1.5rem; color: var(--primary-color); margin-bottom: 0.5rem;"></i>
            <div class="software-stat-label">Total</div>
            <div class="software-stat-value">${total}</div>
            <div class="software-stat-subtext">users</div>
          </div>
        `;
        metricsContainer.className = 'device-metrics software-metrics-grid';
        metricsContainer.style.display = 'grid';
      } else {
        // For regular devices, show QR code if available
        if (currentDevice.qrCode) {
          metricsContainer.innerHTML = `
            <div class="qr-code-metrics-container">
              <div class="qr-code-metrics-display" onclick="showQRCodeModal('${currentDevice.qrCode}', '${currentDevice.name}', '${currentDevice.id}')" style="cursor: pointer;">
                <canvas id="qr-canvas-metrics" style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); width: 100%; max-width: 200px; height: auto; margin: 0 auto; display: block;"></canvas>
                <div style="margin-top: 1rem; text-align: center;">
                </div>
              </div>
            </div>
          `;
          
          // Generate QR code
          setTimeout(() => {
            const canvas = document.getElementById('qr-canvas-metrics');
            if (canvas) {
              QRCode.toCanvas(canvas, currentDevice.qrCode, {
                width: 200,
                color: {
                  dark: "#000000",
                  light: "#ffffff"
                }
              }, function (error) {
                if (error) {
                  console.error('QR Code generation error:', error);
                }
              });
            }
          }, 100);
          metricsContainer.style.display = 'flex';
        } else {
          metricsContainer.innerHTML = '';
          metricsContainer.style.display = 'none';
        }
      }
      
      // Control modes - empty (not used)
      const controlModesContainer = document.getElementById('controlModes');
      controlModesContainer.innerHTML = '';
      controlModesContainer.style.display = 'none';
      
      // Note section in header - for both software accounts and regular devices
      const noteSection = document.getElementById('detailNoteSection');
      if (currentDevice.note) {
        noteSection.innerHTML = `
          <div class="detail-note-content">
            <div class="detail-note-label" style="font-weight: 600; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">
              Note
            </div>
            <div class="detail-note-text" style="background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 1rem; color: var(--text-primary); font-size: 0.875rem; line-height: 1.6; white-space: pre-wrap;">${currentDevice.note}</div>
          </div>
        `;
        noteSection.style.display = 'block';
      } else {
        noteSection.innerHTML = '';
        noteSection.style.display = 'none';
      }
      
      // Overview (build t·ª´ng ph·∫ßn ƒë·ªÉ tr√°nh l·ªói template l·ªìng nhau)
      const statusOptions = isSoftwareAccount 
        ? ['ACTIVE', 'EXPIRED']
        : ['IN_STOCK','IN_USE','MAINTENANCE','BROKEN'];
      const statusSelectOptions = statusOptions.map(s => `
        <option value="${s}" ${currentDevice.status === s ? 'selected' : ''}>
          ${AssetFlowUtils.getStatusDisplayName(s)}
        </option>
      `).join('');
      
      const holderOptions = allEmployees.map(u => `
        <option value="${u.id}" ${currentDevice.holder && currentDevice.holder.id === u.id ? 'selected' : ''}>
          ${u.name} (${u.department || u.team || ''})
        </option>
      `).join('');
      
      const isComponentDevice = currentDevice.isChild === true;
      
      // Th√¥ng tin thi·∫øt b·ªã cha cho Component
      let parentInfoHtml = '';
      if (isComponentDevice && currentDevice.parentDevice) {
        parentInfoHtml = `
          <div class="info-item">
            <div class="info-label">Parent Device</div>
            <div class="info-value">
              <a id="overviewParentName" href="device-detail.html?id=${currentDevice.parentDevice.id}" style="color: var(--primary-color); text-decoration: none;">
                ${currentDevice.parentDevice.name}
              </a>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Parent Serial</div>
            <div class="info-value" id="overviewParentSerial">${currentDevice.parentDevice.serialNumber}</div>
          </div>
        `;
      }
      
      let holderInfoHtml = '';
      if (currentDevice.holder) {
        holderInfoHtml = `
          <div class="info-item">
            <div class="info-label">Assigned To</div>
            <div class="info-value" id="overviewAssignedName">${currentDevice.holder.name}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Team</div>
            <div class="info-value" id="overviewTeamName">${currentDevice.holder.team || 'N/A'}</div>
          </div>
        `;
      }
      
      // V·ªõi Component (thi·∫øt b·ªã con), n·∫øu thi·∫øu th√¥ng tin th√¨ fallback sang thi·∫øt b·ªã cha
      const effectivePurchaseDate = currentDevice.purchaseDate 
        || (isComponentDevice && currentDevice.parentDevice && currentDevice.parentDevice.purchaseDate);
      const effectiveWarrantyExpiry = currentDevice.warrantyExpiry 
        || (isComponentDevice && currentDevice.parentDevice && currentDevice.parentDevice.warrantyExpiry);
      const effectivePrice = typeof currentDevice.price === 'number' 
        ? currentDevice.price 
        : (isComponentDevice && typeof currentDevice.parentDevice?.price === 'number' 
          ? currentDevice.parentDevice.price 
          : null);
      
      let purchaseHtml = '';
      if (effectivePurchaseDate) {
        purchaseHtml = `
          <div class="info-item">
            <div class="info-label">Purchase Date</div>
            <div class="info-value">${AssetFlowUtils.formatDate(effectivePurchaseDate)}</div>
          </div>
        `;
      }
      
      let warrantyHtml = '';
      if (effectiveWarrantyExpiry) {
        warrantyHtml = `
          <div class="info-item">
            <div class="info-label">Warranty Expiry</div>
            <div class="info-value">${AssetFlowUtils.formatDate(effectiveWarrantyExpiry)}</div>
          </div>
        `;
      }
      
      let priceHtml = '';
      if (effectivePrice) {
        priceHtml = `
          <div class="info-item">
            <div class="info-label">Price</div>
            <div class="info-value">${AssetFlowUtils.formatCurrency(effectivePrice)}</div>
          </div>
        `;
      }
      
      let assignedDateHtml = '';
      if (currentDevice.assignedDate) {
        assignedDateHtml = `
          <div class="info-item">
            <div class="info-label">Assigned Date</div>
            <div class="info-value">${AssetFlowUtils.formatDate(currentDevice.assignedDate)}</div>
          </div>
        `;
      }
      
      // Software account specific fields
      let softwareAccountHtml = '';
      if (isSoftwareAccount) {
        softwareAccountHtml = `
          ${currentDevice.provider ? `
            <div class="info-item">
              <div class="info-label">Provider</div>
              <div class="info-value">${currentDevice.provider}</div>
            </div>
          ` : ''}
          ${currentDevice.licenseType ? `
            <div class="info-item">
              <div class="info-label">License Type</div>
              <div class="info-value">${currentDevice.licenseType}</div>
            </div>
          ` : ''}
          ${currentDevice.totalLicenses !== undefined ? `
            <div class="info-item">
              <div class="info-label">Total Licenses</div>
              <div class="info-value">${currentDevice.totalLicenses}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Used Licenses</div>
              <div class="info-value">${currentDevice.usedLicenses || 0}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Available Licenses</div>
              <div class="info-value">${(currentDevice.totalLicenses || 0) - (currentDevice.usedLicenses || 0)}</div>
            </div>
          ` : ''}
          ${currentDevice.expiryDate ? `
            <div class="info-item">
              <div class="info-label">Expiry Date</div>
              <div class="info-value">${AssetFlowUtils.formatDate(currentDevice.expiryDate)}</div>
            </div>
          ` : ''}
          ${currentDevice.description ? `
            <div class="info-item" style="grid-column: 1 / -1;">
              <div class="info-label">Description</div>
              <div class="info-value">${currentDevice.description}</div>
            </div>
          ` : ''}
        `;
      }
      
      let assignedCardHtml = '';
      if (isSoftwareAccount) {
        // Migrate assignedUsers to assignedDevices if needed (for backward compatibility)
        if (!currentDevice.assignedDevices && currentDevice.assignedUsers && currentDevice.assignedUsers.length > 0) {
          // Load ƒë·∫ßy ƒë·ªß th√¥ng tin user t·ª´ allEmployees khi migrate
          currentDevice.assignedDevices = currentDevice.assignedUsers.map(user => {
            const fullUser = allEmployees.find(u => u.id === user.id) || user;
            return {
              type: 'user',
              user: {
                ...user,
                ...fullUser,
                // ƒê·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin
                team: fullUser.team || fullUser.department || user.team,
                department: fullUser.department || fullUser.team || user.team
              },
              assignedDate: user.assignedDate || new Date().toISOString().split('T')[0]
            };
          });
        }
        
        // For Software & Licenses: show assigned devices instead of users
        const assignedDevices = currentDevice.assignedDevices || [];
        const totalAssigned = assignedDevices.length;
        const deviceCount = assignedDevices.filter(item => item.type === 'device').length;
        const userCount = assignedDevices.filter(item => item.type === 'user').length;
        
        const assignedList = assignedDevices.map((item, index) => {
          if (item.type === 'device') {
            // Load ƒë·∫ßy ƒë·ªß th√¥ng tin device t·ª´ allDevices n·∫øu c·∫ßn
            let fullDevice = item.device;
            if (item.device.id && (!item.device.name || !item.device.location)) {
              // T√¨m device ƒë·∫ßy ƒë·ªß t·ª´ allDevices
              const foundDevice = allDevices.find(d => d.id === item.device.id);
              if (foundDevice) {
                fullDevice = foundDevice;
              }
            }
            
            // T√™n m√°y PC/Laptop
            const displayName = fullDevice.name || fullDevice.id || 'Unknown Device';
            // Location/Team
            const location = fullDevice.location || fullDevice.holder?.team || '';
            // T√™n ng∆∞·ªùi ƒëang s·ª≠ d·ª•ng m√°y (holder)
            const holderName = fullDevice.holder?.name || '';
            
            return `
              <div class="assigned-tag-item" data-index="${index}">
                <div class="assigned-tag-content">
                  <div class="assigned-tag-name" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); margin-bottom: 0.375rem;">${displayName}</div>
                  ${location ? `
                    <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                      <i class="fas fa-map-marker-alt" style="color: #ec4899; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                      <span style="color: #60a5fa; font-size: 0.75rem;">${location}</span>
                    </div>
                  ` : ''}
                  ${holderName ? `
                    <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                      <i class="fas fa-user" style="color: #a855f7; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                      <span style="color: #60a5fa; font-size: 0.75rem;">${holderName}</span>
                    </div>
                  ` : ''}
                </div>
                <button class="assigned-tag-remove" onclick="removeAssignedItem(${index})" type="button" aria-label="Remove">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
          } else {
            // N·∫øu c√≥ user (t·ª´ d·ªØ li·ªáu c≈©), load ƒë·∫ßy ƒë·ªß th√¥ng tin t·ª´ allEmployees
            let fullUser = item.user;
            if (item.user.id && (!item.user.team || !item.user.department)) {
              // T√¨m user ƒë·∫ßy ƒë·ªß t·ª´ allEmployees
              const foundUser = allEmployees.find(u => u.id === item.user.id);
              if (foundUser) {
                fullUser = { ...item.user, ...foundUser };
              }
            }
            
            const displayName = fullUser.name || 'Unknown User';
            const team = fullUser.team || fullUser.department || '';
            
            return `
              <div class="assigned-tag-item" data-index="${index}">
                <div class="assigned-tag-content">
                  <div class="assigned-tag-name" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); margin-bottom: 0.375rem;">${displayName}</div>
                  ${team ? `
                    <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                      <i class="fas fa-map-marker-alt" style="color: #ec4899; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                      <span style="color: #60a5fa; font-size: 0.75rem;">${team}</span>
                    </div>
                  ` : ''}
                </div>
                <button class="assigned-tag-remove" onclick="removeAssignedItem(${index})" type="button" aria-label="Remove">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            `;
          }
        }).join('');
        
        assignedCardHtml = `
          <div class="assigned-card">
            <div class="assigned-card-title">
              Assigned PC/Laptop
              <span style="font-size: 0.875rem; font-weight: normal; color: var(--text-secondary); margin-left: 0.5rem;">
                (total: ${totalAssigned})
              </span>
            </div>
            <div style="margin-bottom: 1rem;">
              <div style="position: relative;">
                <input type="text" id="assignSearchInput" class="search-input" placeholder="Search PC/Laptop by name, serial, or owner..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px;">
                <div id="assignSearchResults" class="search-results-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-top: 0.25rem; max-height: 300px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1);"></div>
              </div>
            </div>
            <div class="assigned-tags-container">
              ${assignedList || '<span style="color: var(--text-secondary); font-size: 0.875rem; align-self: center;">No PC/Laptop assigned yet.</span>'}
            </div>
          </div>
        `;
      } else if (!isSoftwareAccount && currentDevice.holder) {
        const holderLocation = currentDevice.location || (currentDevice.holder.team || '');
        assignedCardHtml = `
          <div class="assigned-card">
            <div class="assigned-card-title">Currently Assigned To</div>
            <div class="assigned-card-main">
              <div class="assigned-card-avatar">
                ${currentDevice.holder.name.charAt(0)}
              </div>
              <div class="assigned-card-info">
                <div class="assigned-card-name">${currentDevice.holder.name}</div>
                <div class="assigned-card-email">${currentDevice.holder.email}</div>
                ${holderLocation ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">üìç ${holderLocation}</div>` : ''}
              </div>
            </div>
          </div>
        `;
      }
      
      document.getElementById('overviewContent').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem;">
          ${!isSoftwareAccount ? `
            <div class="info-item">
              <div class="info-label">Serial Number</div>
              <div class="info-value">${currentDevice.serialNumber || 'N/A'}</div>
            </div>
          ` : `
            <div class="info-item">
              <div class="info-label">Account ID</div>
              <div class="info-value">${currentDevice.id}</div>
            </div>
          `}
          <div class="info-item">
            <div class="info-label">Type</div>
            <div class="info-value">${currentDevice.type}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Category</div>
            <div class="info-value">${currentDevice.category}</div>
          </div>
          ${parentInfoHtml}
          <div class="info-item">
            <div class="info-label">Status</div>
            <div class="info-value">
              <div class="custom-dropdown" id="detailStatusDropdown">
                <button class="custom-dropdown-button" type="button">
                  <span class="custom-dropdown-text">${AssetFlowUtils.getStatusDisplayName(currentDevice.status)}</span>
                  <i class="fas fa-chevron-down custom-dropdown-icon"></i>
                </button>
                <div class="custom-dropdown-menu">
                  ${statusOptions.map(s => `
                    <div class="custom-dropdown-option ${currentDevice.status === s ? 'selected' : ''}" data-value="${s}">
                      ${AssetFlowUtils.getStatusDisplayName(s)}
                    </div>
                  `).join('')}
                </div>
                <select class="filter-dropdown hidden" id="detailStatusSelect">
                  ${statusSelectOptions}
                </select>
              </div>
            </div>
          </div>
          ${!isSoftwareAccount ? holderInfoHtml : ''}
          ${!isSoftwareAccount ? purchaseHtml : ''}
          ${!isSoftwareAccount ? warrantyHtml : ''}
          ${priceHtml}
          ${!isSoftwareAccount ? assignedDateHtml : ''}
          ${softwareAccountHtml}
          ${!isSoftwareAccount ? (
            isComponentDevice
              ? `
                <div class="info-item">
                  <div class="info-label">Quick Parent Device Change</div>
                  <div class="info-value">
                    <div class="custom-dropdown" id="detailParentDeviceDropdown">
                      <button class="custom-dropdown-button" type="button">
                        <span class="custom-dropdown-text">${currentDevice.parentDevice ? `${currentDevice.parentDevice.name} (${currentDevice.parentDevice.serialNumber || currentDevice.parentDevice.id})` : 'Unassigned'}</span>
                        <i class="fas fa-chevron-down custom-dropdown-icon"></i>
                      </button>
                      <div class="custom-dropdown-menu">
                        <div class="custom-dropdown-option ${!currentDevice.parentDevice ? 'selected' : ''}" data-value="">Unassigned</div>
                        ${allDevices
                          .filter(d => d.isParent === true)
                          .map(d => `
                            <div class="custom-dropdown-option ${currentDevice.parentDevice && currentDevice.parentDevice.id === d.id ? 'selected' : ''}" data-value="${d.id}">
                              ${d.name} (${d.serialNumber || d.id})
                            </div>
                          `).join('')}
                      </div>
                      <select class="filter-dropdown hidden" id="detailParentDeviceSelect">
                        <option value="">Unassigned</option>
                        ${allDevices
                          .filter(d => d.isParent === true)
                          .map(d => `
                            <option value="${d.id}" ${currentDevice.parentDevice && currentDevice.parentDevice.id === d.id ? 'selected' : ''}>
                              ${d.name} (${d.serialNumber || d.id})
                            </option>
                          `).join('')}
                      </select>
                    </div>
                  </div>
                </div>
              `
              : `
                <div class="info-item">
                  <div class="info-label">Quick Holder Change</div>
                  <div class="info-value">
                    <div class="custom-dropdown" id="detailHolderDropdown">
                      <button class="custom-dropdown-button" type="button">
                        <span class="custom-dropdown-text">${currentDevice.holder ? `${currentDevice.holder.name} (${currentDevice.holder.team || currentDevice.holder.department || ''})` : 'Unassigned'}</span>
                        <i class="fas fa-chevron-down custom-dropdown-icon"></i>
                      </button>
                      <div class="custom-dropdown-menu">
                        <div class="holder-search-wrapper" style="padding: 0.5rem; border-bottom: 1px solid var(--border-color); position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                          <div style="position: relative;">
                            <i class="fas fa-search" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.875rem; pointer-events: none;"></i>
                            <input type="text" id="holderSearchInput" class="holder-search-input" placeholder="Search by name, email, team..." style="width: 100%; padding: 0.5rem 0.75rem 0.5rem 2.25rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.875rem; outline: none; transition: border-color 0.2s;" onfocus="this.style.borderColor='var(--primary-color)'" onblur="this.style.borderColor='var(--border-color)'">
                          </div>
                        </div>
                        <div class="holder-options-container" id="holderOptionsContainer">
                          <div class="custom-dropdown-option ${!currentDevice.holder ? 'selected' : ''}" data-value="" data-search-text="unassigned">Unassigned</div>
                          ${allEmployees.map(u => `
                            <div class="custom-dropdown-option ${currentDevice.holder && currentDevice.holder.id === u.id ? 'selected' : ''}" data-value="${u.id}" data-search-text="${(u.name + ' ' + (u.email || '') + ' ' + (u.department || '') + ' ' + (u.team || '')).toLowerCase()}">
                              ${u.name} (${u.department || u.team || ''})
                            </div>
                          `).join('')}
                        </div>
                      </div>
                      <select class="filter-dropdown hidden" id="detailHolderSelect">
                        <option value="">Unassigned</option>
                        ${holderOptions}
                      </select>
                    </div>
                  </div>
                </div>
              `
          ) : ''}
        </div>
        ${assignedCardHtml}
      `;
      
      // Initialize custom dropdowns for detail page
      initializeDetailDropdowns();
      
      // G·∫Øn handler cho quick status & holder
      const statusSelectEl = document.getElementById('detailStatusSelect');
      if (statusSelectEl) {
        statusSelectEl.addEventListener('change', () => {
          const newStatus = statusSelectEl.value;
          if (!newStatus) return;
          currentDevice.status = newStatus;
          
          // C·∫≠p nh·∫≠t header badge
          headerStatusBadge.className = `status-badge status-${currentDevice.status}`;
          headerStatusBadge.textContent = AssetFlowUtils.getStatusDisplayName(currentDevice.status);
          
          // Update custom dropdown button text
          const statusDropdown = document.getElementById('detailStatusDropdown');
          if (statusDropdown) {
            const buttonText = statusDropdown.querySelector('.custom-dropdown-text');
            if (buttonText) {
              buttonText.textContent = AssetFlowUtils.getStatusDisplayName(newStatus);
            }
            // Update selected option
            const options = statusDropdown.querySelectorAll('.custom-dropdown-option');
            options.forEach(opt => {
              opt.classList.remove('selected');
              if (opt.dataset.value === newStatus) {
                opt.classList.add('selected');
              }
            });
          }
          
          AssetFlowUtils.showToast(`Device status changed to ${AssetFlowUtils.getStatusDisplayName(newStatus)} (mock only, not saved).`, 'success');
        });
      }
      
      // Quick change holder cho thi·∫øt b·ªã th∆∞·ªùng (kh√¥ng ph·∫£i Component / Software)
      const holderSelectEl = document.getElementById('detailHolderSelect');
      if (holderSelectEl && !isComponentDevice && !isSoftwareAccount) {
        holderSelectEl.addEventListener('change', () => {
          const holderId = holderSelectEl.value;
          
          if (!holderId) {
            currentDevice.holder = null;
            const assignedEl = document.getElementById('overviewAssignedName');
            const teamEl = document.getElementById('overviewTeamName');
            if (assignedEl) assignedEl.textContent = 'Unassigned';
            if (teamEl) teamEl.textContent = 'N/A';
            
            // Update custom dropdown button text
            const holderDropdown = document.getElementById('detailHolderDropdown');
            if (holderDropdown) {
              const buttonText = holderDropdown.querySelector('.custom-dropdown-text');
              if (buttonText) {
                buttonText.textContent = 'Unassigned';
              }
              // Update selected option
              const options = holderDropdown.querySelectorAll('.custom-dropdown-option');
              options.forEach(opt => {
                opt.classList.remove('selected');
                if (!opt.dataset.value) {
                  opt.classList.add('selected');
                }
              });
            }
            
            AssetFlowUtils.showToast('Device holder cleared (mock only, not saved).', 'success');
            return;
          }
          
          const user = allEmployees.find(u => u.id === holderId);
          if (!user) {
            AssetFlowUtils.showToast('Selected employee not found.', 'error');
            return;
          }
          
          currentDevice.holder = {
            id: user.id,
            name: user.name,
            email: user.email,
            team: user.team || user.department
          };
          
          const assignedEl2 = document.getElementById('overviewAssignedName');
          const teamEl2 = document.getElementById('overviewTeamName');
          if (assignedEl2) assignedEl2.textContent = currentDevice.holder.name;
          if (teamEl2) teamEl2.textContent = currentDevice.holder.team || 'N/A';
          document.getElementById('locationText').textContent = currentDevice.holder.team || currentDevice.location;
          
          // Update custom dropdown button text
          const holderDropdown = document.getElementById('detailHolderDropdown');
          if (holderDropdown) {
            const buttonText = holderDropdown.querySelector('.custom-dropdown-text');
            if (buttonText) {
              buttonText.textContent = `${user.name} (${user.team || user.department || ''})`;
            }
            // Update selected option
            const options = holderDropdown.querySelectorAll('.custom-dropdown-option');
            options.forEach(opt => {
              opt.classList.remove('selected');
              if (opt.dataset.value === holderId) {
                opt.classList.add('selected');
              }
            });
          }
          
          AssetFlowUtils.showToast(`Device assigned to ${user.name} (mock only, not saved).`, 'success');
        });
      }
      
      // Quick change Parent Device cho Component
      const parentSelectEl = document.getElementById('detailParentDeviceSelect');
      if (parentSelectEl && isComponentDevice && !isSoftwareAccount) {
        parentSelectEl.addEventListener('change', () => {
          const parentId = parentSelectEl.value;
          
          if (!parentId) {
            currentDevice.parentDevice = null;
            
            // Update custom dropdown button text
            const parentDropdown = document.getElementById('detailParentDeviceDropdown');
            if (parentDropdown) {
              const buttonText = parentDropdown.querySelector('.custom-dropdown-text');
              if (buttonText) {
                buttonText.textContent = 'Unassigned';
              }
              // Update selected option
              const options = parentDropdown.querySelectorAll('.custom-dropdown-option');
              options.forEach(opt => {
                opt.classList.remove('selected');
                if (!opt.dataset.value) {
                  opt.classList.add('selected');
                }
              });
            }
            
            AssetFlowUtils.showToast('Component is now detached from parent device (mock only, not saved).', 'success');
            return;
          }
          
          const parentDevice = allDevices.find(d => d.id === parentId);
          if (!parentDevice) {
            AssetFlowUtils.showToast('Selected parent device not found.', 'error');
            return;
          }
          
          // C·∫≠p nh·∫≠t th√¥ng tin thi·∫øt b·ªã cha v√† k·∫ø th·ª´a holder/location t·ª´ cha
          currentDevice.parentDevice = {
            id: parentDevice.id,
            name: parentDevice.name,
            serialNumber: parentDevice.serialNumber,
            location: parentDevice.location,
            holder: parentDevice.holder
          };
          
          currentDevice.location = parentDevice.location;
          currentDevice.holder = parentDevice.holder;
          
          // C·∫≠p nh·∫≠t UI ph·∫ßn Parent info
          const parentNameEl = document.getElementById('overviewParentName');
          const parentSerialEl = document.getElementById('overviewParentSerial');
          if (parentNameEl) {
            parentNameEl.textContent = parentDevice.name;
            parentNameEl.href = `device-detail.html?id=${parentDevice.id}`;
          }
          if (parentSerialEl) {
            parentSerialEl.textContent = parentDevice.serialNumber || parentDevice.id;
          }
          
          // C·∫≠p nh·∫≠t Assigned To card n·∫øu c√≥
          const assignedEl2 = document.getElementById('overviewAssignedName');
          const teamEl2 = document.getElementById('overviewTeamName');
          if (assignedEl2 && parentDevice.holder) {
            assignedEl2.textContent = parentDevice.holder.name;
          }
          if (teamEl2 && parentDevice.holder) {
            teamEl2.textContent = parentDevice.holder.team || 'N/A';
          }
          
          // Update custom dropdown button text
          const parentDropdown = document.getElementById('detailParentDeviceDropdown');
          if (parentDropdown) {
            const buttonText = parentDropdown.querySelector('.custom-dropdown-text');
            if (buttonText) {
              buttonText.textContent = `${parentDevice.name} (${parentDevice.serialNumber || parentDevice.id})`;
            }
            // Update selected option
            const options = parentDropdown.querySelectorAll('.custom-dropdown-option');
            options.forEach(opt => {
              opt.classList.remove('selected');
              if (opt.dataset.value === parentId) {
                opt.classList.add('selected');
              }
            });
          }
          
          AssetFlowUtils.showToast('Component parent device changed (mock only, not saved).', 'success');
        });
      }
      
      // Initialize assigned devices search for Software & Licenses
      if (isSoftwareAccount) {
        initializeAssignedDevicesSearch();
      }
      
      // Hide/show tabs based on device type
      const hierarchyTabBtn = document.getElementById('hierarchyTabBtn');
      const specsTabBtn = document.getElementById('specsTabBtn');
      const specsTabTitle = document.getElementById('specsTabTitle');
      const addComponentBtn = document.getElementById('addComponentBtn');
      if (isSoftwareAccount) {
        if (hierarchyTabBtn) hierarchyTabBtn.style.display = 'none';
        if (specsTabBtn) {
          specsTabBtn.style.display = '';
          specsTabBtn.textContent = 'Account Details';
        }
        if (specsTabTitle) specsTabTitle.textContent = 'Account Details';
        if (addComponentBtn) addComponentBtn.style.display = 'none';
      } else {
        if (hierarchyTabBtn) hierarchyTabBtn.style.display = '';
        if (specsTabBtn) {
          specsTabBtn.style.display = '';
          specsTabBtn.textContent = 'Specifications';
        }
        if (specsTabTitle) specsTabTitle.textContent = 'Technical Specifications';
        // Show Add Component button only for container devices
        if (addComponentBtn) {
          addComponentBtn.style.display = currentDevice.isParent === true ? 'inline-flex' : 'none';
        }
      }
      
      // Hierarchy
      if (!isSoftwareAccount) {
        renderHierarchy();
      }
      
      // History
      renderHistory();
      
      // Specs
      if (!isSoftwareAccount) {
        renderSpecs();
      } else {
        renderSoftwareAccountDetails();
      }
    }
    
    function renderHierarchy() {
      const tree = document.getElementById('hierarchyTree');
      tree.innerHTML = '';
      
      // N·∫øu l√† component (ho·∫∑c b·∫•t k·ª≥ thi·∫øt b·ªã n√†o ƒë∆∞·ª£c load t·ª´ parentDevice) -> hi·ªÉn th·ªã quan h·ªá Cha -> Con
      if (currentDevice.parentDevice) {
        const parent = currentDevice.parentDevice;
        
        const parentNode = document.createElement('div');
        parentNode.className = 'tree-node parent';
        parentNode.innerHTML = `
          <div class="tree-node-header">
            <div class="tree-node-title">
              <span class="tree-node-icon">${AssetFlowUtils.getDeviceIcon(parent.type || 'Container')}</span>
              <span>${parent.name}</span>
            </div>
            <a href="device-detail.html?id=${parent.id}" style="text-decoration: none; color: var(--primary-color); font-size: 0.875rem;">View Parent</a>
          </div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">SN: ${parent.serialNumber}</div>
        `;
        
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'tree-node-children';
        
        const childNode = document.createElement('div');
        childNode.className = 'tree-node';
        childNode.innerHTML = `
          <div class="tree-node-header">
            <div class="tree-node-title">
              <span class="tree-node-icon">${AssetFlowUtils.getDeviceIcon(currentDevice.type)}</span>
              <span>${currentDevice.name}</span>
            </div>
            <span class="status-badge status-${currentDevice.status}">${AssetFlowUtils.getStatusDisplayName(currentDevice.status)}</span>
          </div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">SN: ${currentDevice.serialNumber}</div>
          <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">QR: ${currentDevice.qrCode}</div>
        `;
        
        childrenContainer.appendChild(childNode);
        parentNode.appendChild(childrenContainer);
        tree.appendChild(parentNode);
        return;
      }
      
      // M·∫∑c ƒë·ªãnh: hi·ªÉn th·ªã device hi·ªán t·∫°i (b·∫•t k·ª≥ thi·∫øt b·ªã n√†o c√≥ children, v√≠ d·ª• container ho·∫∑c PC c√≥ component)
      if (currentDevice.children && currentDevice.children.length > 0) {
        const parentNode = document.createElement('div');
        parentNode.className = 'tree-node parent';
        parentNode.innerHTML = `
          <div class="tree-node-header">
            <div class="tree-node-title">
              <span class="tree-node-icon">${AssetFlowUtils.getDeviceIcon(currentDevice.type)}</span>
              <span>${currentDevice.name}</span>
            </div>
            <span class="status-badge status-${currentDevice.status}">${AssetFlowUtils.getStatusDisplayName(currentDevice.status)}</span>
          </div>
          <div style="font-size: 0.875rem; color: var(--text-secondary);">${currentDevice.serialNumber}</div>
        `;
        
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'tree-node-children';
        
        currentDevice.children.forEach(child => {
          const childNode = document.createElement('div');
          childNode.className = 'tree-node clickable';
          childNode.innerHTML = `
            <div class="tree-node-header">
              <div class="tree-node-title">
                <span class="tree-node-icon">${AssetFlowUtils.getDeviceIcon(child.type)}</span>
                <span>${child.name}</span>
              </div>
              <span class="status-badge status-${child.status}">${AssetFlowUtils.getStatusDisplayName(child.status)}</span>
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">SN: ${child.serialNumber}</div>
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">QR: ${child.qrCode}</div>
          `;
          
          // Click c·∫£ block ƒë·ªÉ ƒëi t·ªõi chi ti·∫øt component
          childNode.addEventListener('click', () => {
            window.location.href = `device-detail.html?id=${child.id}`;
          });
          
          childrenContainer.appendChild(childNode);
        });
        
        parentNode.appendChild(childrenContainer);
        tree.appendChild(parentNode);
      } else {
        tree.innerHTML = `
          <div class="tree-node">
            <div class="tree-node-header">
              <div class="tree-node-title">
                <span class="tree-node-icon">${AssetFlowUtils.getDeviceIcon(currentDevice.type)}</span>
                <span>${currentDevice.name}</span>
              </div>
              <span class="status-badge status-${currentDevice.status}">${AssetFlowUtils.getStatusDisplayName(currentDevice.status)}</span>
            </div>
            <div style="font-size: 0.875rem; color: var(--text-secondary);">${currentDevice.serialNumber}</div>
            ${currentDevice.children && currentDevice.children.length === 0 ? '<div style="margin-top: 1rem; color: var(--text-secondary);">No child components</div>' : ''}
          </div>
        `;
      }
    }
    
    // ----- Add Component Flow -----
    function openAddComponentModal() {
      if (!currentDevice || currentDevice.isParent !== true) return;
      
      const modal = document.getElementById('addComponentModal');
      const wrapper = document.getElementById('componentSelectWrapper');
      const display = document.getElementById('componentSelectDisplay');
      const optionsContainer = document.getElementById('componentOptions');
      const select = document.getElementById('componentSelect');
      const emptyState = document.getElementById('componentEmptyState');
      const confirmBtn = document.getElementById('confirmAddComponentBtn');
      
      if (!modal || !wrapper || !display || !optionsContainer || !select || !emptyState || !confirmBtn) return;
      
      // Build component options (all Component devices, excluding current and already-added children)
      const existingIds = new Set(
        (currentDevice.children || []).map(child => child.id)
      );
      
      const availableComponents = allDevices
        .filter(d => d.isChild === true && d.id !== currentDevice.id && !existingIds.has(d.id));
      
      // Reset UI
      select.innerHTML = '';
      optionsContainer.innerHTML = '';
      display.textContent = 'Select a component...';
      wrapper.classList.remove('open');
      
      if (availableComponents.length === 0) {
        emptyState.style.display = 'block';
        wrapper.style.display = 'none';
        confirmBtn.disabled = true;
      } else {
        emptyState.style.display = 'none';
        wrapper.style.display = 'block';
        confirmBtn.disabled = false;
        
        // Build hidden select options
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a component...';
        select.appendChild(placeholder);
        
        availableComponents.forEach(component => {
          const option = document.createElement('option');
          option.value = component.id;
          option.textContent = `${component.name} (${component.serialNumber || component.id})`;
          select.appendChild(option);
          
          // Build visual option with icon
          const optionDiv = document.createElement('div');
          optionDiv.className = 'component-option';
          optionDiv.dataset.id = component.id;
          optionDiv.innerHTML = `
            <div class="component-option-icon">
              ${AssetFlowUtils.getDeviceIcon(component.type)}
            </div>
            <div class="component-option-text">
              <div class="component-option-name">${component.name}</div>
              <div class="component-option-meta">${component.serialNumber || component.id}</div>
            </div>
          `;
          
          optionDiv.addEventListener('click', () => {
            // Mark selected visually
            optionsContainer.querySelectorAll('.component-option').forEach(el => el.classList.remove('selected'));
            optionDiv.classList.add('selected');
            
            // Update display text
            display.textContent = `${component.name} (${component.serialNumber || component.id})`;
            
            // Sync hidden select
            select.value = component.id;
            
            // Close dropdown
            wrapper.classList.remove('open');
          });
          
          optionsContainer.appendChild(optionDiv);
        });
      }
      
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeAddComponentModal() {
      const modal = document.getElementById('addComponentModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
    
    function handleConfirmAddComponent() {
      const select = document.getElementById('componentSelect');
      if (!select || !currentDevice) return;
      
      const selectedId = select.value;
      if (!selectedId) {
        AssetFlowUtils.showToast('Please select a component to add.', 'warning');
        return;
      }
      
      const component = allDevices.find(d => d.id === selectedId);
      if (!component) {
        AssetFlowUtils.showToast('Selected component not found.', 'error');
        return;
      }
      
      if (!Array.isArray(currentDevice.children)) {
        currentDevice.children = [];
      }
      
      if (currentDevice.children.some(child => child.id === component.id)) {
        AssetFlowUtils.showToast('Component already added to this device.', 'info');
        closeAddComponentModal();
        return;
      }
      
      // Add shallow copy of component as child (front-end only, not persisted)
      currentDevice.children.push({
        ...component
      });
      
      AssetFlowUtils.showToast('Component added to hierarchy (mock only, not saved).', 'success');
      closeAddComponentModal();
      renderHierarchy();
    }
    
    function renderHistory() {
      const isSoftwareAccount = currentDevice.isSoftwareAccount || currentDevice.category === 'Software Account';
      const lifecycleEvents = [];
      
      if (isSoftwareAccount) {
        // Software account lifecycle
        if (currentDevice.purchaseDate) {
          lifecycleEvents.push({
            date: currentDevice.purchaseDate,
            event: 'Purchase',
            details: [
              currentDevice.provider ? `Account purchased from ${currentDevice.provider}` : 'Account purchased',
              currentDevice.price ? `Value: ${AssetFlowUtils.formatCurrency(currentDevice.price)}` : null
            ].filter(Boolean)
          });
        }
        
        if (currentDevice.assignedUsers && currentDevice.assignedUsers.length > 0) {
          currentDevice.assignedUsers.forEach(user => {
            if (user.assignedDate) {
              lifecycleEvents.push({
                date: user.assignedDate,
                event: 'Assignment',
                details: [
                  `Assigned to ${user.name}`,
                  user.team ? `Team: ${user.team}` : null
                ].filter(Boolean)
              });
            }
          });
        }
        
        if (currentDevice.expiryDate) {
          lifecycleEvents.push({
            date: currentDevice.expiryDate,
            event: 'Expiry',
            details: [
              'Subscription expired',
              'License renewal required'
            ]
          });
        }
      } else {
        // Device lifecycle - Build realistic timeline
        const purchaseDate = currentDevice.purchaseDate || new Date(Date.now() - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const assignedDate = currentDevice.assignedDate || new Date(Date.now() - 300 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        const assignedName = currentDevice.holder && currentDevice.holder.name
          ? currentDevice.holder.name
          : 'Nguyen Van A';
        const location = currentDevice.location || 'Floor 3 - IT Department';
        
        // Purchase event
        lifecycleEvents.push({
          date: purchaseDate,
          event: 'New Purchase',
          details: [
            currentDevice.price ? `Asset purchased from vendor` : 'Asset purchased',
            currentDevice.price ? `Value: ${AssetFlowUtils.formatCurrency(currentDevice.price)}` : null
          ].filter(Boolean)
        });
        
        // Deployment event
        lifecycleEvents.push({
          date: assignedDate,
          event: 'Deployment',
          details: [
            `Assigned to ${assignedName} - ${currentDevice.holder?.department || 'IT Department'}`,
            `Location: ${location}`
          ]
        });
        
        // Maintenance events if status is MAINTENANCE
        if (currentDevice.status === 'MAINTENANCE') {
          const maintenanceDate = new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          const maintenanceCompleteDate = new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          
          lifecycleEvents.push({
            date: maintenanceDate,
            event: 'Maintenance',
            details: [
              'Keyboard replacement',
              'Cost: 2,000,000 VND'
            ]
          });
          
          lifecycleEvents.push({
            date: maintenanceCompleteDate,
            event: 'Maintenance Completed',
            details: [
              'Returned to user'
            ]
          });
        }
      }
      
      // Sort by date (newest first - latest events on top)
      lifecycleEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      const historyContent = document.getElementById('historyContent');
      if (lifecycleEvents.length > 0) {
        historyContent.innerHTML = lifecycleEvents.map((event, index) => {
          const eventDate = new Date(event.date);
          const formattedDate = eventDate.toLocaleDateString('en-GB', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric' 
          });
          
          const isLast = index === lifecycleEvents.length - 1;
          
          return `
            <div class="lifecycle-event">
              <div class="lifecycle-date">${formattedDate}</div>
              <div class="lifecycle-line-container">
                <div class="lifecycle-dot"></div>
                ${!isLast ? '<div class="lifecycle-line"></div>' : ''}
              </div>
              <div class="lifecycle-content">
                <div class="lifecycle-event-title">${event.event}</div>
                ${event.details && event.details.length > 0 ? `
                  <div class="lifecycle-details">
                    ${event.details.map(detail => `<div class="lifecycle-detail-item">${detail}</div>`).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
      } else {
        historyContent.innerHTML = '<div style="color: var(--text-secondary); padding: 2rem; text-align: center;">No lifecycle history available</div>';
      }
    }
    
    function renderSpecs() {
      const specsGrid = document.getElementById('specsGrid');
      const isSoftwareAccount = currentDevice.isSoftwareAccount || currentDevice.category === 'Software Account';
      
      if (isSoftwareAccount) {
        renderSoftwareAccountDetails();
        return;
      }
      
      if (currentDevice.specs && Object.keys(currentDevice.specs).length > 0) {
        specsGrid.innerHTML = Object.entries(currentDevice.specs).map(([key, value]) => `
          <div class="spec-item">
            <div class="spec-label">${key.charAt(0).toUpperCase() + key.slice(1)}</div>
            <div class="spec-value">${value}</div>
          </div>
        `).join('');
      } else {
        specsGrid.innerHTML = '<div style="color: var(--text-secondary);">No specifications available</div>';
      }
      
      // Add price info
      if (currentDevice.price) {
        const priceItem = document.createElement('div');
        priceItem.className = 'spec-item';
        priceItem.innerHTML = `
          <div class="spec-label">Price</div>
          <div class="spec-value">${AssetFlowUtils.formatCurrency(currentDevice.price)}</div>
        `;
        specsGrid.appendChild(priceItem);
      }
    }
    
    function renderSoftwareAccountDetails() {
      const specsGrid = document.getElementById('specsGrid');
      const isSoftwareAccount = currentDevice.isSoftwareAccount || currentDevice.category === 'Software Account';
      
      if (!isSoftwareAccount) return;
      
      const details = [];
      
      if (currentDevice.provider) {
        details.push({ label: 'Provider', value: currentDevice.provider });
      }
      
      if (currentDevice.licenseType) {
        details.push({ label: 'License Type', value: currentDevice.licenseType });
      }
      
      if (currentDevice.totalLicenses !== undefined) {
        details.push({ label: 'Total Licenses', value: currentDevice.totalLicenses });
        details.push({ label: 'Used Licenses', value: currentDevice.usedLicenses || 0 });
        details.push({ label: 'Available Licenses', value: (currentDevice.totalLicenses || 0) - (currentDevice.usedLicenses || 0) });
      }
      
      if (currentDevice.purchaseDate) {
        details.push({ label: 'Purchase Date', value: AssetFlowUtils.formatDate(currentDevice.purchaseDate) });
      }
      
      if (currentDevice.expiryDate) {
        details.push({ label: 'Expiry Date', value: AssetFlowUtils.formatDate(currentDevice.expiryDate) });
      }
      
      if (currentDevice.price) {
        details.push({ label: 'Price', value: AssetFlowUtils.formatCurrency(currentDevice.price) });
      }
      
      if (currentDevice.description) {
        details.push({ label: 'Description', value: currentDevice.description, fullWidth: true });
      }
      
      if (details.length > 0) {
        specsGrid.innerHTML = details.map(detail => `
          <div class="spec-item" ${detail.fullWidth ? 'style="grid-column: 1 / -1;"' : ''}>
            <div class="spec-label">${detail.label}</div>
            <div class="spec-value">${detail.value}</div>
          </div>
        `).join('');
      } else {
        specsGrid.innerHTML = '<div style="color: var(--text-secondary);">No account details available</div>';
      }
    }
    
    
    
    // Initialize assigned devices search for Software & Licenses
    function initializeAssignedDevicesSearch() {
      const searchInput = document.getElementById('assignSearchInput');
      const searchResults = document.getElementById('assignSearchResults');
      
      if (!searchInput || !searchResults) return;
      
      // Initialize assignedDevices if not exists
      if (!currentDevice.assignedDevices) {
        // Migrate from assignedUsers if exists
        if (currentDevice.assignedUsers && currentDevice.assignedUsers.length > 0) {
          // T√¨m PC/Laptop c·ªßa t·ª´ng user v√† convert sang device
          currentDevice.assignedDevices = currentDevice.assignedUsers.map(user => {
            // T√¨m PC/Laptop m√† user n√†y ƒëang s·ªü h·ªØu
            const userPC = allDevices.find(d => {
              const isPCorLaptop = d.type === 'Laptop' || d.type === 'PC Case' || d.type === 'Desktop';
              return isPCorLaptop && d.holder && d.holder.id === user.id;
            });
            
            if (userPC) {
              // N·∫øu t√¨m th·∫•y PC/Laptop, s·ª≠ d·ª•ng device ƒë√≥
              return {
                type: 'device',
                device: {
                  ...userPC,
                  name: userPC.name || userPC.id,
                  location: userPC.location,
                  holder: userPC.holder
                },
                assignedDate: user.assignedDate || new Date().toISOString().split('T')[0]
              };
            } else {
              // N·∫øu kh√¥ng t√¨m th·∫•y PC/Laptop, gi·ªØ nguy√™n user (fallback)
              const fullUser = allEmployees.find(u => u.id === user.id) || user;
              return {
                type: 'user',
                user: {
                  ...user,
                  ...fullUser,
                  team: fullUser.team || fullUser.department || user.team,
                  department: fullUser.department || fullUser.team || user.team
                },
                assignedDate: user.assignedDate || new Date().toISOString().split('T')[0]
              };
            }
          });
        } else {
          currentDevice.assignedDevices = [];
        }
      }
      
      let searchTimeout = null;
      
      // Show all items when clicking on input
      searchInput.addEventListener('click', () => {
        performSearch('', searchResults);
      });
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.trim().toLowerCase();
        
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
          performSearch(query, searchResults);
        }, 300);
      });
      
      // Close dropdown when clicking outside (but not when clicking on items inside)
      let closeTimeout = null;
      document.addEventListener('click', (e) => {
        // Check if click is inside search results container or on result item
        const clickedInsideResults = searchResults.contains(e.target);
        const clickedOnResultItem = e.target.closest('.search-result-item');
        const clickedInsideInput = searchInput.contains(e.target);
        
        // If clicking on result item or inside results, don't close
        if (clickedInsideResults || clickedOnResultItem || clickedInsideInput) {
          // Clear any pending close timeout
          if (closeTimeout) {
            clearTimeout(closeTimeout);
            closeTimeout = null;
          }
          return;
        }
        
        // Only close if clicking completely outside
        // Use a small delay to allow onclick handlers to run first
        closeTimeout = setTimeout(() => {
          searchResults.style.display = 'none';
        }, 100);
      });
      
      searchInput.addEventListener('focus', () => {
        performSearch(searchInput.value.trim().toLowerCase(), searchResults);
      });
    }
    
    function performSearch(query, resultsContainer) {
      const results = [];
      
      // Ch·ªâ search trong devices (PC/Laptop), kh√¥ng search users
      // C√≥ th·ªÉ search theo t√™n m√°y, serial, type, ho·∫∑c t√™n ng∆∞·ªùi s·ªü h·ªØu
      allDevices.forEach(device => {
        // Ch·ªâ hi·ªÉn th·ªã PC/Laptop (Laptop, PC Case, Desktop)
        const isPCorLaptop = device.type === 'Laptop' || device.type === 'PC Case' || device.type === 'Desktop';
        
        if (!isPCorLaptop) return;
        
        // N·∫øu c√≥ query, filter theo query
        if (query) {
          const nameMatch = device.name.toLowerCase().includes(query);
          const serialMatch = device.serialNumber && device.serialNumber.toLowerCase().includes(query);
          const typeMatch = device.type && device.type.toLowerCase().includes(query);
          
          // Search theo t√™n ng∆∞·ªùi s·ªü h·ªØu (holder)
          const holderNameMatch = device.holder && device.holder.name && device.holder.name.toLowerCase().includes(query);
          const holderEmailMatch = device.holder && device.holder.email && device.holder.email.toLowerCase().includes(query);
          
          if (!(nameMatch || serialMatch || typeMatch || holderNameMatch || holderEmailMatch)) {
            return; // Skip if doesn't match query
          }
        }
        
        // Check if already assigned
        const isAssigned = currentDevice.assignedDevices && currentDevice.assignedDevices.some(item => 
          item.type === 'device' && item.device.id === device.id
        );
        
        // Hi·ªÉn th·ªã t·∫•t c·∫£ (c·∫£ ƒë√£ ch·ªçn v√† ch∆∞a ch·ªçn)
        results.push({
          type: 'device',
          device: device,
          displayName: device.name,
          subtitle: `${device.type} ‚Ä¢ ${device.serialNumber || device.id}`,
          isAssigned: isAssigned
        });
      });
      
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div style="padding: 1rem; color: var(--text-secondary); text-align: center;">No results found</div>';
      } else {
        // Gi·ªØ nguy√™n th·ª© t·ª± danh s√°ch, kh√¥ng sort
        
        resultsContainer.innerHTML = results.map((result, index) => {
          let locationInfo = '';
          let holderInfo = '';
          
          if (result.type === 'device') {
            // Hi·ªÉn th·ªã location/team n·∫øu c√≥
            const location = result.device.location || result.device.holder?.team || '';
            if (location) {
              locationInfo = `
                <div style="display: flex; align-items: center; margin-top: 0.25rem;">
                  <i class="fas fa-map-marker-alt" style="color: #ec4899; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                  <span style="color: #60a5fa; font-size: 0.875rem;">${location}</span>
                </div>
              `;
            }
            // Lu√¥n hi·ªÉn th·ªã holder name n·∫øu c√≥ (ng∆∞·ªùi ƒëang s·ª≠ d·ª•ng m√°y)
            const holderName = result.device.holder?.name || '';
            if (holderName) {
              holderInfo = `
                <div style="display: flex; align-items: center; margin-top: 0.25rem;">
                  <i class="fas fa-user" style="color: #a855f7; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                  <span style="color: #60a5fa; font-size: 0.875rem;">${holderName}</span>
                </div>
              `;
            }
          }
          
          // Style cho item ƒë√£ ch·ªçn
          const itemStyle = result.isAssigned 
            ? 'padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s; background: #e0f2fe; border-left: 3px solid #0ea5e9;'
            : 'padding: 1rem; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;';
          
          const hoverStyle = result.isAssigned
            ? "this.style.background='#bae6fd'"
            : "this.style.background='var(--bg-tertiary)'";
          
          const outStyle = result.isAssigned
            ? "this.style.background='#e0f2fe'"
            : "this.style.background='white'";
          
          const icon = result.isAssigned 
            ? '<i class="fas fa-check-circle" style="color: #0ea5e9; font-size: 1.25rem; margin-left: 1rem;"></i>'
            : '<i class="fas fa-plus" style="color: var(--primary-color); font-size: 1.25rem; margin-left: 1rem;"></i>';
          
          return `
            <div class="search-result-item" onclick="event.stopPropagation(); event.preventDefault(); addAssignedItem(${index}, '${result.type}'); return false;" style="${itemStyle}" onmouseover="${hoverStyle}" onmouseout="${outStyle}">
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 1rem; color: var(--text-primary); margin-bottom: 0.5rem;">${result.displayName}</div>
                ${locationInfo}
                ${holderInfo}
              </div>
              ${icon}
            </div>
          `;
        }).join('');
      }
      
      // Store results for add function
      window.currentSearchResults = results;
      resultsContainer.style.display = 'block';
    }
    
    function addAssignedItem(index, itemType) {
      if (!window.currentSearchResults || !window.currentSearchResults[index]) return;
      
      const result = window.currentSearchResults[index];
      
      // N·∫øu item ƒë√£ ƒë∆∞·ª£c ch·ªçn, remove n√≥
      if (result.isAssigned) {
        const assignedIndex = currentDevice.assignedDevices.findIndex(item => 
          item.type === 'device' && item.device.id === result.device.id
        );
        if (assignedIndex !== -1) {
          removeAssignedItem(assignedIndex);
          return;
        }
      }
      
      // N·∫øu ch∆∞a ch·ªçn, add v√†o
      const assignedItem = {
        type: itemType,
        assignedDate: new Date().toISOString().split('T')[0]
      };
      
      if (itemType === 'device') {
        // L∆∞u to√†n b·ªô th√¥ng tin device, ƒë·∫£m b·∫£o c√≥ ƒë·∫ßy ƒë·ªß th√¥ng tin t·ª´ allDevices
        const fullDevice = allDevices.find(d => d.id === result.device.id) || result.device;
        assignedItem.device = {
          ...fullDevice,
          name: fullDevice.name || result.displayName || fullDevice.id,
          location: fullDevice.location,
          holder: fullDevice.holder
        };
      } else {
        assignedItem.user = result.user;
      }
      
      if (!currentDevice.assignedDevices) {
        currentDevice.assignedDevices = [];
      }
      
      currentDevice.assignedDevices.push(assignedItem);
      
      // Update used licenses count
      if (currentDevice.totalLicenses !== undefined) {
        currentDevice.usedLicenses = currentDevice.assignedDevices.length;
      }
      
      // Update only assigned tags container instead of full re-render
      requestAnimationFrame(() => {
        updateAssignedTagsContainer();
        
        // Refresh search results only if dropdown is already open
        const searchInput = document.getElementById('assignSearchInput');
        const searchResults = document.getElementById('assignSearchResults');
        if (searchInput && searchResults && searchResults.style.display === 'block') {
          // Only refresh if dropdown is already visible
          performSearch(searchInput.value.trim().toLowerCase(), searchResults);
        }
      });
      
      AssetFlowUtils.showToast(`${itemType === 'device' ? 'Device' : 'User'} added successfully`, 'success');
    }
    
    function updateAssignedTagsContainer() {
      const container = document.querySelector('.assigned-tags-container');
      if (!container) return;
      
      const assignedDevices = currentDevice.assignedDevices || [];
      const totalAssigned = assignedDevices.length;
      
      // Update title count
      const titleElement = document.querySelector('.assigned-card-title');
      if (titleElement) {
        const countSpan = titleElement.querySelector('span');
        if (countSpan) {
          countSpan.textContent = `(total: ${totalAssigned})`;
        } else {
          titleElement.innerHTML = `
            Assigned PC/Laptop
            <span style="font-size: 0.875rem; font-weight: normal; color: var(--text-secondary); margin-left: 0.5rem;">
              (total: ${totalAssigned})
            </span>
          `;
        }
      }
      
      // Update container content
      const assignedList = assignedDevices.map((item, index) => {
        if (item.type === 'device') {
          let fullDevice = item.device;
          if (item.device.id && (!item.device.name || !item.device.location)) {
            const foundDevice = allDevices.find(d => d.id === item.device.id);
            if (foundDevice) {
              fullDevice = foundDevice;
            }
          }
          
          const displayName = fullDevice.name || fullDevice.id || 'Unknown Device';
          const location = fullDevice.location || fullDevice.holder?.team || '';
          const holderName = fullDevice.holder?.name || '';
          
          return `
            <div class="assigned-tag-item" data-index="${index}">
              <div class="assigned-tag-content">
                <div class="assigned-tag-name" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); margin-bottom: 0.375rem;">${displayName}</div>
                ${location ? `
                  <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                    <i class="fas fa-map-marker-alt" style="color: #ec4899; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                    <span style="color: #60a5fa; font-size: 0.75rem;">${location}</span>
                  </div>
                ` : ''}
                ${holderName ? `
                  <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                    <i class="fas fa-user" style="color: #a855f7; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                    <span style="color: #60a5fa; font-size: 0.75rem;">${holderName}</span>
                  </div>
                ` : ''}
              </div>
              <button class="assigned-tag-remove" onclick="removeAssignedItem(${index})" type="button" aria-label="Remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        } else {
          let fullUser = item.user;
          if (item.user.id && (!item.user.team || !item.user.department)) {
            const foundUser = allEmployees.find(u => u.id === item.user.id);
            if (foundUser) {
              fullUser = { ...item.user, ...foundUser };
            }
          }
          
          const displayName = fullUser.name || 'Unknown User';
          const team = fullUser.team || fullUser.department || '';
          
          return `
            <div class="assigned-tag-item" data-index="${index}">
              <div class="assigned-tag-content">
                <div class="assigned-tag-name" style="font-weight: 600; font-size: 0.875rem; color: var(--text-primary); margin-bottom: 0.375rem;">${displayName}</div>
                ${team ? `
                  <div class="assigned-tag-info" style="display: flex; align-items: center; margin-top: 0.2rem;">
                    <i class="fas fa-map-marker-alt" style="color: #ec4899; margin-right: 0.25rem; font-size: 0.75rem;"></i>
                    <span style="color: #60a5fa; font-size: 0.75rem;">${team}</span>
                  </div>
                ` : ''}
              </div>
              <button class="assigned-tag-remove" onclick="removeAssignedItem(${index})" type="button" aria-label="Remove">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        }
      }).join('');
      
      // Hide container during update to prevent layout shift
      const originalDisplay = container.style.display;
      container.style.visibility = 'hidden';
      container.style.opacity = '0';
      
      // Use DocumentFragment to batch DOM updates
      const fragment = document.createDocumentFragment();
      const tempDiv = document.createElement('div');
      
      // Set content to temp div first
      tempDiv.innerHTML = assignedList || '<span style="color: var(--text-secondary); font-size: 0.875rem; align-self: center;">No PC/Laptop assigned yet.</span>';
      
      // Move all children from temp div to fragment
      while (tempDiv.firstChild) {
        fragment.appendChild(tempDiv.firstChild);
      }
      
      // Batch update: clear and append in one operation
      container.textContent = '';
      container.appendChild(fragment);
      
      // Restore visibility after a brief delay to ensure DOM is updated
      requestAnimationFrame(() => {
        container.style.visibility = '';
        container.style.opacity = '';
      });
    }
    
    function removeAssignedItem(index) {
      if (!currentDevice.assignedDevices || index >= currentDevice.assignedDevices.length) return;
      
      const item = currentDevice.assignedDevices[index];
      const itemName = item.type === 'device' ? item.device.name : item.user.name;
      
      // Remove item from DOM first (smooth removal)
      const container = document.querySelector('.assigned-tags-container');
      const itemElement = container?.querySelector(`[data-index="${index}"]`);
      if (itemElement) {
        // Fade out animation
        itemElement.style.transition = 'opacity 0.15s ease-out';
        itemElement.style.opacity = '0';
        
        setTimeout(() => {
          // Remove from data
          currentDevice.assignedDevices.splice(index, 1);
          
          // Update used licenses count
          if (currentDevice.totalLicenses !== undefined) {
            currentDevice.usedLicenses = currentDevice.assignedDevices.length;
          }
          
          // Update container (will re-index all items)
          updateAssignedTagsContainer();
          
          // Refresh search results only if dropdown is already open
          const searchInput = document.getElementById('assignSearchInput');
          const searchResults = document.getElementById('assignSearchResults');
          if (searchInput && searchResults && searchResults.style.display === 'block') {
            // Only refresh if dropdown is already visible
            performSearch(searchInput.value.trim().toLowerCase(), searchResults);
          }
        }, 150);
      } else {
        // Fallback if element not found
        currentDevice.assignedDevices.splice(index, 1);
        
        // Update used licenses count
        if (currentDevice.totalLicenses !== undefined) {
          currentDevice.usedLicenses = currentDevice.assignedDevices.length;
        }
        
        updateAssignedTagsContainer();
        
        // Refresh search results only if dropdown is already open
        const searchInput = document.getElementById('assignSearchInput');
        const searchResults = document.getElementById('assignSearchResults');
        if (searchInput && searchResults && searchResults.style.display === 'block') {
          // Only refresh if dropdown is already visible
          performSearch(searchInput.value.trim().toLowerCase(), searchResults);
        }
      }
      
      AssetFlowUtils.showToast(`${item.type === 'device' ? 'Device' : 'User'} removed: ${itemName}`, 'success');
    }
    
    function printQR() {
      AssetFlowUtils.showToast('QR code print dialog opened', 'success');
      // In real implementation, this would open a print dialog with QR code
    }
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById(tabName + 'Tab').classList.add('active');
      });
    });
    
    // Add Component button handlers
    document.getElementById('addComponentBtn')?.addEventListener('click', openAddComponentModal);
    
    // Toggle component dropdown
    document.getElementById('componentSelectDisplay')?.addEventListener('click', () => {
      const wrapper = document.getElementById('componentSelectWrapper');
      if (!wrapper) return;
      wrapper.classList.toggle('open');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const wrapper = document.getElementById('componentSelectWrapper');
      if (!wrapper) return;
      const isInside = wrapper.contains(e.target);
      const isOpenClick = e.target.id === 'componentSelectDisplay';
      if (!isInside && wrapper.classList.contains('open')) {
        wrapper.classList.remove('open');
      }
    });
    document.getElementById('addComponentModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'addComponentModal') {
        closeAddComponentModal();
      }
    });
    document.getElementById('cancelAddComponentBtn')?.addEventListener('click', closeAddComponentModal);
    document.getElementById('confirmAddComponentBtn')?.addEventListener('click', handleConfirmAddComponent);
    
    loadDevice();
  </script>
</body>
</html>

